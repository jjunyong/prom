# Kubernetes 1.20.8 ëª¨ë‹ˆí„°ë§ ê°€ì´ë“œ - Part 2

## 8. Grafana ëŒ€ì‹œë³´ë“œ ì„¤ì • (ê³„ì†)

### Step 8.1: ì»¤ìŠ¤í…€ ëŒ€ì‹œë³´ë“œ JSON íŒŒì¼ ìƒì„±
```bash
cat > dashboards/kia-main-dashboard.json <<'EOF'
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    {
      "datasource": "Prometheus",
      "description": "í˜„ì¬ ì„œë¹„ìŠ¤ ê°€ìš©ì„±",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {"color": "red", "value": null},
              {"color": "yellow", "value": 95},
              {"color": "green", "value": 99}
            ]
          },
          "unit": "percent"
        }
      },
      "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0},
      "id": 1,
      "options": {
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "pluginVersion": "8.5.27",
      "targets": [
        {
          "expr": "avg(up{job=\"spring-boot-pods\",app=\"api-dpl\"}) * 100",
          "legendFormat": "Availability",
          "refId": "A"
        }
      ],
      "title": "ì„œë¹„ìŠ¤ ê°€ìš©ì„± (SLA)",
      "type": "gauge"
    },
    {
      "datasource": "Prometheus",
      "description": "ì´ˆë‹¹ ìš”ì²­ ì²˜ë¦¬ëŸ‰",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "palette-classic"},
          "custom": {
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {"type": "linear"},
            "showPoints": "never",
            "spanNulls": true,
            "stacking": {"group": "A", "mode": "none"},
            "thresholdsStyle": {"mode": "off"}
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [{"color": "green", "value": null}]
          },
          "unit": "reqps"
        }
      },
      "gridPos": {"h": 8, "w": 12, "x": 6, "y": 0},
      "id": 2,
      "options": {
        "legend": {
          "calcs": ["mean", "max"],
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": {"mode": "single"}
      },
      "targets": [
        {
          "expr": "sum(rate(istio_request_total{destination_service_namespace=\"default\",destination_service_name=\"api-dpl-service\"}[5m]))",
          "legendFormat": "Request Rate",
          "refId": "A"
        }
      ],
      "title": "ìš”ì²­ ì²˜ë¦¬ìœ¨ (RPS)",
      "type": "timeseries"
    },
    {
      "datasource": "Prometheus",
      "description": "P95 ì‘ë‹µì‹œê°„",
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {"color": "green", "value": null},
              {"color": "yellow", "value": 500},
              {"color": "red", "value": 1000}
            ]
          },
          "unit": "ms"
        }
      },
      "gridPos": {"h": 8, "w": 6, "x": 18, "y": 0},
      "id": 3,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(istio_request_duration_milliseconds_bucket{destination_service_namespace=\"default\"}[5m])) by (le))",
          "legendFormat": "P95",
          "refId": "A"
        }
      ],
      "title": "P95 ì‘ë‹µì‹œê°„",
      "type": "stat"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 30,
  "style": "dark",
  "tags": ["kia", "production"],
  "templating": {"list": []},
  "time": {"from": "now-1h", "to": "now"},
  "timepicker": {},
  "timezone": "Asia/Seoul",
  "title": "KIA.com ë©”ì¸ ëŒ€ì‹œë³´ë“œ",
  "uid": "kia-main",
  "version": 1,
  "weekStart": ""
}
EOF
```

### Step 8.2: ConfigMapìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ ë°°í¬
```bash
cat > dashboards/configmap-dashboard.yaml <<'EOF'
apiVersion: v1
kind: ConfigMap
metadata:
  name: kia-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  kia-dashboard.json: |
    {
      "dashboard": {
        "title": "KIA Web Service Dashboard",
        "panels": [],
        "refresh": "30s",
        "time": {"from": "now-1h", "to": "now"}
      }
    }
EOF

kubectl apply -f dashboards/configmap-dashboard.yaml
```

### Step 8.3: Grafana ì ‘ì† ë° ëŒ€ì‹œë³´ë“œ Import

```bash
# Grafana ì ‘ì† ì •ë³´ í™•ì¸
echo "===== Grafana ì ‘ì† ì •ë³´ ====="
echo "URL: http://localhost:3000"
echo "Username: admin"
echo "Password: KiaMonitoring2024!"

# Port-forward ì„¤ì •
kubectl port-forward -n monitoring svc/prometheus-stack-grafana 3000:80
```

**ë¸Œë¼ìš°ì €ì—ì„œ ëŒ€ì‹œë³´ë“œ Import:**
1. http://localhost:3000 ì ‘ì†
2. ë¡œê·¸ì¸ (admin / KiaMonitoring2024!)
3. ì¢Œì¸¡ ë©”ë‰´ â†’ Dashboards â†’ Import
4. ë‹¤ìŒ Dashboard ID ì…ë ¥:
   - `7636` : Istio Service Mesh Dashboard
   - `12900` : Spring Boot 2.1 Statistics
   - `4701` : JVM (Micrometer)
   - `8588` : Kubernetes Cluster Monitoring (K8s 1.20 í˜¸í™˜)
5. ë˜ëŠ” ìœ„ì—ì„œ ìƒì„±í•œ `kia-main-dashboard.json` íŒŒì¼ ì—…ë¡œë“œ

---

## 9. Alert Rules ì„¤ì •

### Step 9.1: Alert Rules YAML ìƒì„±
```bash
cat > alerts/alert-rules.yaml <<'EOF'
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kia-web-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
    release: prometheus-stack  # Helm release ì´ë¦„ê³¼ ì¼ì¹˜
spec:
  groups:
  - name: kia.web.sla
    interval: 30s
    rules:
    # ë†’ì€ ì—ëŸ¬ìœ¨ ì•Œë¦¼
    - alert: HighErrorRate
      expr: |
        (sum(rate(istio_request_total{destination_service_namespace="default",response_code=~"5.."}[5m])) 
        / sum(rate(istio_request_total{destination_service_namespace="default"}[5m]))) > 0.01
      for: 5m
      labels:
        severity: critical
        service: kia-web
        team: platform
      annotations:
        summary: "ë†’ì€ ì—ëŸ¬ìœ¨ ê°ì§€ ({{ $value | humanizePercentage }})"
        description: "ì§€ë‚œ 5ë¶„ê°„ ì—ëŸ¬ìœ¨ì´ 1%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬: {{ $value | humanizePercentage }}"
    
    # ë†’ì€ ì‘ë‹µì‹œê°„ ì•Œë¦¼
    - alert: HighLatency
      expr: |
        histogram_quantile(0.95,
          sum(rate(istio_request_duration_milliseconds_bucket{destination_service_namespace="default"}[5m])) 
          by (le)
        ) > 1000
      for: 5m
      labels:
        severity: warning
        service: kia-web
        team: platform
      annotations:
        summary: "ë†’ì€ ì‘ë‹µì‹œê°„ ê°ì§€"
        description: "P95 ì‘ë‹µì‹œê°„ì´ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬: {{ $value }}ms"
    
    # ì„œë¹„ìŠ¤ ë‹¤ìš´ ì•Œë¦¼
    - alert: ServiceDown
      expr: up{job="spring-boot-pods",app="api-dpl"} == 0
      for: 2m
      labels:
        severity: critical
        service: kia-api
        team: platform
      annotations:
        summary: "ì„œë¹„ìŠ¤ ë‹¤ìš´"
        description: "{{ $labels.pod }} íŒŒë“œê°€ 2ë¶„ ì´ìƒ ë‹¤ìš´ ìƒíƒœì…ë‹ˆë‹¤."
    
    # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì•Œë¦¼
    - alert: HighMemoryUsage
      expr: |
        (sum(jvm_memory_used_bytes{application="kia-api-service",area="heap"}) 
        / sum(jvm_memory_max_bytes{application="kia-api-service",area="heap"})) > 0.85
      for: 5m
      labels:
        severity: warning
        service: kia-api
        team: platform
      annotations:
        summary: "ë†’ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰"
        description: "JVM í™ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 85%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬: {{ $value | humanizePercentage }}"
    
    # ë°°ì¹˜ ì‘ì—… ì‹¤íŒ¨ ì•Œë¦¼
    - alert: BatchJobFailed
      expr: batch_job_status != 0
      for: 1m
      labels:
        severity: warning
        service: batch
        team: data
      annotations:
        summary: "ë°°ì¹˜ ì‘ì—… ì‹¤íŒ¨"
        description: "{{ $labels.job_name }} ë°°ì¹˜ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: {{ $value }}"
    
    # ë°°ì¹˜ ì‘ì—… ì§€ì—° ì•Œë¦¼
    - alert: BatchJobDelayed
      expr: |
        (time() - batch_job_last_success_timestamp) > 7200
      for: 5m
      labels:
        severity: warning
        service: batch
        team: data
      annotations:
        summary: "ë°°ì¹˜ ì‘ì—… ì§€ì—°"
        description: "{{ $labels.job_name }} ì‘ì—…ì´ 2ì‹œê°„ ì´ìƒ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    
    # DB ì—°ê²° í’€ ê³ ê°ˆ ì•Œë¦¼
    - alert: DatabaseConnectionPoolExhausted
      expr: |
        (hikaricp_connections_active{application="kia-api-service"} 
        / hikaricp_connections_max{application="kia-api-service"}) > 0.9
      for: 3m
      labels:
        severity: critical
        service: database
        team: platform
      annotations:
        summary: "DB ì—°ê²° í’€ ê³ ê°ˆ ì„ë°•"
        description: "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ ì‚¬ìš©ëŸ‰ì´ 90%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜„ì¬: {{ $value | humanizePercentage }}"
    
    # Pod ì¬ì‹œì‘ ì•Œë¦¼
    - alert: PodRestartingTooOften
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="default",pod=~"api-dpl-.*"}[1h]) > 0.5
      for: 5m
      labels:
        severity: warning
        service: kia-api
        team: platform
      annotations:
        summary: "Pod ë¹ˆë²ˆí•œ ì¬ì‹œì‘"
        description: "{{ $labels.pod }} Podì´ ì‹œê°„ë‹¹ 0.5íšŒ ì´ìƒ ì¬ì‹œì‘ë˜ê³  ìˆìŠµë‹ˆë‹¤."
EOF

kubectl apply -f alerts/alert-rules.yaml
```

---

## 10. ì„¤ì¹˜ ê²€ì¦

### Step 10.1: ì „ì²´ ì‹œìŠ¤í…œ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
```bash
cat > verify-installation.sh <<'EOF'
#!/bin/bash

echo "======================================"
echo "KIA ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì„¤ì¹˜ ê²€ì¦"
echo "Kubernetes ë²„ì „: 1.20.8"
echo "======================================"

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# í•¨ìˆ˜: ìƒíƒœ ì²´í¬
check_status() {
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $1"
    else
        echo -e "${RED}âœ—${NC} $1"
        return 1
    fi
}

# 0. Kubernetes ë²„ì „ í™•ì¸
echo -e "\n${YELLOW}0. Kubernetes ë²„ì „ í™•ì¸${NC}"
SERVER_VERSION=$(kubectl version --short 2>/dev/null | grep "Server Version" | awk '{print $3}')
echo "Server Version: $SERVER_VERSION"
if [[ "$SERVER_VERSION" == *"1.20"* ]]; then
    echo -e "${GREEN}âœ“${NC} Kubernetes 1.20.x í™•ì¸ë¨"
else
    echo -e "${YELLOW}!${NC} Kubernetes ë²„ì „ì´ 1.20.xê°€ ì•„ë‹™ë‹ˆë‹¤. í˜¸í™˜ì„± ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
fi

# 1. Namespace í™•ì¸
echo -e "\n${YELLOW}1. Namespace í™•ì¸${NC}"
kubectl get namespace monitoring > /dev/null 2>&1
check_status "monitoring namespace ì¡´ì¬"

# 2. Prometheus í™•ì¸
echo -e "\n${YELLOW}2. Prometheus ìƒíƒœ${NC}"
kubectl get pod -n monitoring -l app.kubernetes.io/name=prometheus -o wide
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n monitoring --timeout=60s > /dev/null 2>&1
check_status "Prometheus Pod ì‹¤í–‰ì¤‘"

# 3. Grafana í™•ì¸
echo -e "\n${YELLOW}3. Grafana ìƒíƒœ${NC}"
kubectl get pod -n monitoring -l app.kubernetes.io/name=grafana -o wide
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=60s > /dev/null 2>&1
check_status "Grafana Pod ì‹¤í–‰ì¤‘"

# 4. PushGateway í™•ì¸
echo -e "\n${YELLOW}4. PushGateway ìƒíƒœ${NC}"
kubectl get pod -n monitoring -l app=prometheus-pushgateway -o wide
kubectl wait --for=condition=ready pod -l app=prometheus-pushgateway -n monitoring --timeout=60s > /dev/null 2>&1
check_status "PushGateway Pod ì‹¤í–‰ì¤‘"

# 5. ServiceMonitor í™•ì¸
echo -e "\n${YELLOW}5. ServiceMonitor ì„¤ì •${NC}"
kubectl get servicemonitor -n monitoring
check_status "ServiceMonitor ìƒì„±ë¨"

# 6. PrometheusRule í™•ì¸
echo -e "\n${YELLOW}6. Alert Rules ì„¤ì •${NC}"
kubectl get prometheusrule -n monitoring
check_status "PrometheusRule ìƒì„±ë¨"

# 7. API Deployment í™•ì¸
echo -e "\n${YELLOW}7. Spring Boot API ìƒíƒœ${NC}"
kubectl get deployment api-dpl -n default > /dev/null 2>&1
if [ $? -eq 0 ]; then
    kubectl get pod -n default -l app=api-dpl
    check_status "API Deployment ì‹¤í–‰ì¤‘"
else
    echo -e "${YELLOW}! API Deploymentê°€ ì•„ì§ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤${NC}"
fi

# 8. CronJob í™•ì¸ (K8s 1.20ì—ì„œëŠ” batch/v1beta1)
echo -e "\n${YELLOW}8. CronJob ìƒíƒœ (batch/v1beta1)${NC}"
kubectl get cronjob -n default > /dev/null 2>&1
if [ $? -eq 0 ]; then
    kubectl get cronjob -n default
    check_status "CronJob í™•ì¸ë¨"
else
    echo -e "${YELLOW}! CronJobì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤${NC}"
fi

# 9. ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´
echo -e "\n${YELLOW}9. ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´${NC}"
echo "======================================"
GRAFANA_SVC=$(kubectl get svc -n monitoring prometheus-stack-grafana -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
if [ -z "$GRAFANA_SVC" ]; then
    echo "Grafana: kubectl port-forward -n monitoring svc/prometheus-stack-grafana 3000:80"
    echo "         http://localhost:3000"
else
    echo "Grafana: http://$GRAFANA_SVC"
fi
echo "Username: admin"
echo "Password: KiaMonitoring2024!"
echo ""
echo "Prometheus: kubectl port-forward -n monitoring svc/prometheus-prometheus 9090:9090"
echo "           http://localhost:9090"
echo ""
echo "PushGateway: kubectl port-forward -n monitoring svc/prometheus-pushgateway 9091:9091"
echo "            http://localhost:9091"
echo "======================================"

# 10. Metrics ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
echo -e "\n${YELLOW}10. Metrics ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸${NC}"
kubectl port-forward -n monitoring svc/prometheus-prometheus 9090:9090 > /dev/null 2>&1 &
PF_PID=$!
sleep 3

# Prometheus targets í™•ì¸
curl -s http://localhost:9090/api/v1/targets 2>/dev/null | jq '.data.activeTargets | length' > /dev/null 2>&1
if [ $? -eq 0 ]; then
    TARGET_COUNT=$(curl -s http://localhost:9090/api/v1/targets 2>/dev/null | jq '.data.activeTargets | length')
    echo -e "${GREEN}âœ“${NC} Active targets: $TARGET_COUNT"
else
    echo -e "${YELLOW}! Prometheus API ì ‘ì† ì‹¤íŒ¨ (port-forward í•„ìš”)${NC}"
fi

kill $PF_PID 2>/dev/null

# 11. Helm ì„¤ì¹˜ ìƒíƒœ
echo -e "\n${YELLOW}11. Helm ì„¤ì¹˜ ìƒíƒœ${NC}"
helm list -n monitoring
helm status prometheus-stack -n monitoring 2>/dev/null | grep "STATUS:" | head -1

echo -e "\n${GREEN}ì„¤ì¹˜ ê²€ì¦ ì™„ë£Œ!${NC}"
echo "======================================"
echo "K8s 1.20.8 í˜¸í™˜ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì¤€ë¹„ ì™„ë£Œ"
echo "======================================"
EOF

chmod +x verify-installation.sh
./verify-installation.sh
```

---

## 11. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… (K8s 1.20.8 íŠ¹í™”)

### K8s 1.20.8 íŠ¹ìœ  ë¬¸ì œ í•´ê²°

#### API ë²„ì „ ê´€ë ¨ ì—ëŸ¬
```bash
# CronJob API ë²„ì „ í™•ì¸
kubectl api-resources | grep -i cronjob
# batch/v1beta1   true         CronJob

# ë§Œì•½ batch/v1 ì‚¬ìš© ì‹œ ì—ëŸ¬ê°€ ë‚˜ë©´ batch/v1beta1ë¡œ ë³€ê²½
sed -i 's/apiVersion: batch\/v1/apiVersion: batch\/v1beta1/g' *.yaml
```

#### Webhook ì—ëŸ¬ (K8s 1.20)
```bash
# ValidatingWebhookConfiguration ì—ëŸ¬ ì‹œ
kubectl delete validatingwebhookconfiguration prometheus-stack-kube-prom-admission 2>/dev/null
kubectl delete mutatingwebhookconfiguration prometheus-stack-kube-prom-admission 2>/dev/null
```

#### RBAC ê¶Œí•œ ì—ëŸ¬
```bash
# ServiceAccount ê¶Œí•œ ì¶”ê°€
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: prometheus-prometheus
  namespace: monitoring
EOF
```

#### Podì´ Pending ìƒíƒœì¼ ë•Œ
```bash
# PVC ìƒíƒœ í™•ì¸
kubectl get pvc -n monitoring

# StorageClass í™•ì¸ ë° ìˆ˜ì •
kubectl get storageclass
# ê¸°ë³¸ StorageClassê°€ ì—†ìœ¼ë©´ ìƒì„±
kubectl patch storageclass <your-storage-class> -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

# ì´ë²¤íŠ¸ í™•ì¸
kubectl describe pod <pod-name> -n monitoring
```

#### ë©”íŠ¸ë¦­ì´ ìˆ˜ì§‘ë˜ì§€ ì•Šì„ ë•Œ
```bash
# Prometheus targets í™•ì¸
kubectl port-forward -n monitoring svc/prometheus-prometheus 9090:9090
# ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:9090/targets í™•ì¸

# ServiceMonitor ë ˆì´ë¸” í™•ì¸
kubectl get servicemonitor -n monitoring -o yaml | grep -A5 "selector:"

# Pod ì–´ë…¸í…Œì´ì…˜ í™•ì¸
kubectl get pod api-dpl-xxx -n default -o yaml | grep -A5 "annotations:"

# Prometheus ì„¤ì • ë¦¬ë¡œë“œ
kubectl rollout restart statefulset/prometheus-prometheus -n monitoring
```

#### Grafana ëŒ€ì‹œë³´ë“œê°€ ë¹„ì–´ìˆì„ ë•Œ
```bash
# ë°ì´í„°ì†ŒìŠ¤ í™•ì¸
kubectl exec -n monitoring deployment/prometheus-stack-grafana -- \
  curl -s http://admin:KiaMonitoring2024!@localhost:3000/api/datasources

# Prometheus ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
kubectl port-forward -n monitoring svc/prometheus-prometheus 9090:9090
# http://localhost:9090/graph ì—ì„œ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
# ì˜ˆ: up{job="spring-boot-pods"}
```

#### ë¡œê·¸ í™•ì¸
```bash
# Prometheus ë¡œê·¸
kubectl logs -n monitoring -l app.kubernetes.io/name=prometheus --tail=100

# Grafana ë¡œê·¸
kubectl logs -n monitoring -l app.kubernetes.io/name=grafana --tail=100

# Prometheus Operator ë¡œê·¸
kubectl logs -n monitoring -l app.kubernetes.io/component=controller --tail=100

# Spring Boot ì•± ë¡œê·¸
kubectl logs -n default -l app=api-dpl --tail=100
```

### Helm ê´€ë ¨ ë¬¸ì œ í•´ê²°

#### Helm ì—…ê·¸ë ˆì´ë“œ (ì„¤ì • ë³€ê²½ ì‹œ)
```bash
# values íŒŒì¼ ìˆ˜ì • í›„ ì—…ê·¸ë ˆì´ë“œ
helm upgrade prometheus-stack \
  prometheus-community/kube-prometheus-stack \
  --version 45.31.1 \
  -n monitoring \
  -f config/02-prometheus-values-k8s-1.20.yaml

# ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš°
helm rollback prometheus-stack -n monitoring
```

#### ì™„ì „ ì¬ì„¤ì¹˜
```bash
# 1. ê¸°ì¡´ ì„¤ì¹˜ ì‚­ì œ
helm uninstall prometheus-stack -n monitoring

# 2. CRD ì‚­ì œ (í•„ìš”ì‹œ)
kubectl delete crd prometheuses.monitoring.coreos.com
kubectl delete crd prometheusrules.monitoring.coreos.com
kubectl delete crd servicemonitors.monitoring.coreos.com
kubectl delete crd podmonitors.monitoring.coreos.com
kubectl delete crd alertmanagers.monitoring.coreos.com
kubectl delete crd thanosrulers.monitoring.coreos.com

# 3. ì¬ì„¤ì¹˜
helm install prometheus-stack \
  prometheus-community/kube-prometheus-stack \
  --version 45.31.1 \
  -n monitoring \
  -f config/02-prometheus-values-k8s-1.20.yaml
```

---

## ğŸ¯ K8s 1.20.8 ì„¤ì¹˜ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Kubernetes 1.20.8 ë²„ì „ í™•ì¸
- [ ] Monitoring namespace ìƒì„±ë¨
- [ ] Prometheus Stack v45.31.1 ì„¤ì¹˜ ì™„ë£Œ
- [ ] ëª¨ë“  Podì´ Running ìƒíƒœ
- [ ] Grafana ì ‘ì† ê°€ëŠ¥
- [ ] ServiceMonitor ìƒì„±ë¨
- [ ] Alert Rules ì„¤ì •ë¨
- [ ] PushGateway ì‹¤í–‰ì¤‘
- [ ] Spring Boot ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™•ì¸
- [ ] Istio ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™•ì¸
- [ ] CronJob (batch/v1beta1) ë™ì‘ í™•ì¸
- [ ] ëŒ€ì‹œë³´ë“œ Import ì™„ë£Œ

---

## ğŸ“š K8s 1.20.8 ê´€ë ¨ ì°¸ê³  ìë£Œ

- [Kubernetes 1.20 Release Notes](https://kubernetes.io/blog/2020/12/08/kubernetes-1-20-release-announcement/)
- [Prometheus Operator Compatibility](https://github.com/prometheus-operator/prometheus-operator#compatibility)
- [kube-prometheus-stack Version Matrix](https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack#upgrading-chart)

---

## ğŸ’¡ K8s 1.20.8 í™˜ê²½ ìµœì í™” íŒ

1. **API ë²„ì „ ì£¼ì˜ì‚¬í•­**
   - CronJob: `batch/v1beta1` ì‚¬ìš©
   - Ingress: `networking.k8s.io/v1beta1` ì‚¬ìš©
   - ValidatingWebhookConfiguration: ë¹„í™œì„±í™” ê¶Œì¥

2. **ë¦¬ì†ŒìŠ¤ ì œí•œ**
   - Prometheus: ë©”ëª¨ë¦¬ 2Gi ì´í•˜ ê¶Œì¥
   - Grafana: ë©”ëª¨ë¦¬ 1Gië¡œ ì¶©ë¶„

3. **ë³´ì•ˆ ì„¤ì •**
   - PodSecurityPolicy ëŒ€ì‹  RBAC í™œìš©
   - NetworkPolicy ì„¤ì • ê¶Œì¥

4. **ì„±ëŠ¥ ìµœì í™”**
   - scrapeInterval: 30s (ê¸°ë³¸ê°’ ìœ ì§€)
   - retention: 30d (ë””ìŠ¤í¬ ê³µê°„ ê³ ë ¤)

---

## ë¹ ë¥¸ ì„¤ì¹˜ ëª…ë ¹ì–´ ëª¨ìŒ

```bash
# ì „ì²´ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
cat > quick-install.sh <<'EOF'
#!/bin/bash
echo "KIA.com K8s 1.20.8 ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì„¤ì¹˜ ì‹œì‘..."

# 1. ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p kia-monitoring/{config,dashboards,alerts}
cd kia-monitoring

# 2. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
kubectl create namespace monitoring

# 3. Helm repo ì¶”ê°€
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# 4. Prometheus Stack ì„¤ì¹˜ (K8s 1.20.8 í˜¸í™˜)
helm install prometheus-stack \
  prometheus-community/kube-prometheus-stack \
  --version 45.31.1 \
  --namespace monitoring \
  --set prometheusOperator.admissionWebhooks.enabled=false \
  --set kubeControllerManager.enabled=false \
  --set kubeScheduler.enabled=false \
  --set kubeProxy.enabled=false \
  --set grafana.adminPassword="KiaMonitoring2024!"

# 5. ì„¤ì¹˜ í™•ì¸
echo "ì„¤ì¹˜ ì™„ë£Œ. Pod ìƒíƒœ í™•ì¸ì¤‘..."
kubectl get pods -n monitoring

echo "Grafana ì ‘ì†: kubectl port-forward -n monitoring svc/prometheus-stack-grafana 3000:80"
echo "Username: admin / Password: KiaMonitoring2024!"
EOF

chmod +x quick-install.sh
./quick-install.sh
```

---

**ì‘ì„±ì¼**: 2024ë…„
**Kubernetes ë²„ì „**: 1.20.8
**ë²„ì „**: 2.0 (K8s 1.20.8 í˜¸í™˜)
**ì‘ì„±ì**: KIA DevOps Team
